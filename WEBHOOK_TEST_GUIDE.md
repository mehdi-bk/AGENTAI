#!/bin/bash
# Script de test du webhook Stripe en local
# 
# Usage: 
#   1. D'abord, lancer le backend: cd backend && npm run dev
#   2. Dans un autre terminal, lancer le Stripe CLI listener
#   3. Ensuite lancer ce script
#
# PrÃ©requis: Stripe CLI installÃ©e (brew install stripe)

set -e

echo "ðŸŽ¯ WEBHOOK STRIPE - GUIDE DE TEST LOCAL"
echo "========================================"
echo ""
echo "Ã‰tape 1: Installer Stripe CLI (si pas dÃ©jÃ  fait)"
echo "  brew install stripe"
echo ""
echo "Ã‰tape 2: Dans TERMINAL 1 - Lancer le listener Stripe"
echo "  stripe listen --forward-to http://localhost:3001/api/billing/webhook"
echo "  âš ï¸ Cela te donnera une clÃ© WEBHOOK_SECRET Ã  copier dans .env"
echo ""
echo "Ã‰tape 3: Dans TERMINAL 2 - Lancer ce script pour simuler un checkout"
echo "  ./stripe-webhook-test.sh"
echo ""
echo "========================================"
echo ""
echo "FLUX COMPLET:"
echo ""
echo "1. Client remplit les infos de paiement sur Stripe Checkout (frontend)"
echo "   â””â”€> POST /api/billing/checkout (billingService.ts)"
echo "       â”œâ”€ Email: X-Client-Email header"
echo "       â”œâ”€ CSRF Token: X-CSRF-Token header"
echo "       â””â”€ Body: { planId, successUrl, cancelUrl }"
echo ""
echo "2. Stripe redirige vers success_url aprÃ¨s paiement"
echo "   â””â”€> Client voit 'Abonnement actif' dans le dashboard"
echo ""
echo "3. Stripe envoie webhook 'checkout.session.completed'"
echo "   â””â”€ POST /api/billing/webhook (webhook handler)"
echo ""
echo "4. Backend traite le webhook:"
echo "   â”œâ”€ RÃ©cupÃ¨re: email, planId, Stripe customer_id"
echo "   â”œâ”€ Appelle INSTANTLY API (create subscription)"
echo "   â”œâ”€ Appelle DEEPSEECK API (create subscription)"
echo "   â””â”€ Met Ã  jour Client en DB (stripeCustomerId, currentPlan, status)"
echo ""
echo "5. RÃ©sultat:"
echo "   â”œâ”€ Client.stripeCustomerId = Stripe customer ID"
echo "   â”œâ”€ Client.instantlyWorkspaceId = Workspace Instantly crÃ©Ã©"
echo "   â”œâ”€ Client.deepseeckUserId = User Deepseeck crÃ©Ã©"
echo "   â”œâ”€ Client.currentPlan = 'business' (ou autre)"
echo "   â””â”€ Client.instantlyStatus = 'active' / 'inactive' (selon rÃ©sultat)"
echo ""
echo "========================================"
echo ""
echo "VARIABLES D'ENVIRONNEMENT REQUISES (.env backend):"
echo ""
echo "# Stripe"
echo "STRIPE_SECRET_KEY=sk_test_..."
echo "STRIPE_WEBHOOK_SECRET=whsec_... (fourni par 'stripe listen')"
echo "STRIPE_PRICE_DISCOVERY=price_..."
echo "STRIPE_PRICE_BUSINESS=price_..."
echo "STRIPE_PRICE_SCALE=price_..."
echo ""
echo "# Instantly"
echo "INSTANTLY_API_KEY=your_api_key"
echo "INSTANTLY_API_URL=https://api.instantly.ai/v1"
echo ""
echo "# Deepseeck"
echo "DEEPSEECK_API_KEY=your_api_key"
echo "DEEPSEECK_API_URL=https://api.deepseeck.com/v1"
echo ""
echo "========================================"
echo ""
echo "LOGS Ã€ SURVEILLER:"
echo ""
echo "Backend (terminal):"
echo "  - 'ðŸ“© Stripe webhook received: checkout.session.completed'"
echo "  - 'ðŸŽ‰ Checkout session completed for user@example.com'"
echo "  - 'âœ… Instantly subscription created: { ... }'"
echo "  - 'âœ… Deepseeck subscription created: { ... }'"
echo "  - 'âœ… Client updated: user@example.com'"
echo ""
echo "Si erreur Instantly/Deepseeck:"
echo "  - 'âŒ Instantly creation failed' -> VÃ©rifie INSTANTLY_API_KEY"
echo "  - 'âŒ Deepseeck creation failed' -> VÃ©rifie DEEPSEECK_API_KEY"
echo "  - 'âš ï¸ Some integrations failed' -> Mais Client quand mÃªme en DB"
echo ""
echo "========================================"
echo ""
